---
title: "Microsimulation Project"
author: "Mahdi Munshi"
date: "2024-06-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The data for this project was collected from [Kaggle](https://www.kaggle.com/datasets/davidcariboo/player-scores) that has a comprehensive and up-to-date compilation of football data, including detailed match formations. I am using the "games.csv" to get the formation data for the to 5 European football leagues.

First, we'll load the necessary libraries for our analysis - the tidyverse and dplyr packages.

```{r}
library(tidyverse)
library(dplyr)
```

Next, we'll read in the "games.csv" file, which contains the data we'll be working with. This will create a dataframe called "games" that we can start exploring.

```{r}
games <- read.csv("games.csv")
```

To focus our analysis, we'll subset the "games" dataframe to include only the matches from the top 5 European leagues - LaLiga, Ligue 1, Serie A, Premier League, and Bundesliga. This will give us a more manageable dataset to work with.

```{r}
games_2 <- games %>%
  filter(competition_id %in% c("ES1", "FR1", "IT1", "GB1", "L1"))
```

With the subset in hand, we'll remove several variables that we don't need for our current analysis, creating a new dataframe called "games_3". This helps streamline our workflow and keep the data focused on the most relevant information.

```{r}
games_3 <- games_2 %>%
  select(-game_id, -round, -date, -home_club_id, -away_club_id,
         -home_club_position, -away_club_position, -home_club_manager_name,
         -away_club_manager_name, -attendance, -referee, -url, -competition_type)
```

Moving forward, we'll create a new variable called "competition_name" based on the "competition_id" values. This will make it easier to work with the different leagues in our analysis. We'll also reorder the columns in the dataframe to put this new variable first.

```{r}
games_4 <- games_3 %>%
  mutate(competition_name = case_when(
    competition_id == "ES1" ~ "LaLiga",
    competition_id == "FR1" ~ "Ligue 1",
    competition_id == "IT1" ~ "Serie A",
    competition_id == "GB1" ~ "Premier League",
    competition_id == "L1"  ~ "Bundesliga"
  )) %>%
  select(-competition_id) %>%
  select(competition_name, everything())
```

Next, we'll add a "winner" variable to the dataframe, which will indicate whether the home team, away team, or the match was a draw based on the goal scores.

```{r}
# Adding 'winner' variable based on goals comparison
games_5 <- games_4 %>%
  mutate(winner = case_when(
    home_club_goals > away_club_goals ~ "home",
    home_club_goals < away_club_goals ~ "away",
    TRUE ~ "draw"  # Handles the case where goals are equal
  )) %>%
  select(competition_name, season, home_club_goals, away_club_goals, winner, everything())
```

Building on that, we'll create another new variable called "winner_club_name" that will show the name of the winning team (or "Drawn" if the match was a tie).

```{r}
games_6 <- games_5 %>%
  mutate(winner_club_name = case_when(
    winner == "home" ~ home_club_name,
    winner == "away" ~ away_club_name,
    winner == "draw" ~ "Drawn"
  )) %>%
  select(competition_name, season, home_club_goals, away_club_goals, winner,
         home_club_name, away_club_name, winner_club_name, everything())
```

To prepare the data for further analysis, we'll recode the "home_club_formation" and "away_club_formation" variables, converting them to more standardized formats. Yes, the previous formats provide further information to the formations, but it would be difficult to incorporate those information into the model (maybe not that difficult, still I am doing this to keep it simple.)

```{r}
games_7 <- games_6 %>%
  mutate(home_club_formation = recode(home_club_formation,
    `4-3-3 Attacking` = "4-3-3",
    `4-4-2 double 6` = "4-4-2",
    `4-3-3 Defending` = "4-3-3",
    `3-5-2 flat` = "3-5-2",
    `4-4-2 Diamond` = "4-4-2",
    `3-5-2 Attacking` = "3-5-2",
    `4-5-1 flat` = "4-5-1",
    `5-4-1 Diamond` = "5-4-1",
    `3-4-3 Diamond` = "3-4-3"
  ))

games_7 <- games_7 %>%
  mutate(away_club_formation = recode(away_club_formation,
    `4-3-3 Attacking` = "4-3-3",
    `4-4-2 double 6` = "4-4-2",
    `4-3-3 Defending` = "4-3-3",
    `3-5-2 flat` = "3-5-2",
    `4-4-2 Diamond` = "4-4-2",
    `3-5-2 Attacking` = "3-5-2",
    `4-5-1 flat` = "4-5-1",
    `5-4-1 Diamond` = "5-4-1",
    `3-4-3 Diamond` = "3-4-3"
  ))

games_7 <- games_7 %>%
  mutate(across(c(competition_name, season, winner, stadium, home_club_formation, away_club_formation, home_club_name, away_club_name), factor))
```

Let's take a quick look at the factored levels of the formation values present in the data, to check if the levels are the same.

```{r}
unique(games_7$home_club_formation)
unique(games_7$away_club_formation)
```

They are the same.

Finally, we'll remove any rows with missing values from the dataframe, creating the "games_8" dataframe, which will be the foundation for our subsequent analysis and modeling. I am exporting the dataframe into a csv file so that we can ignore all these wrangling codes to run the model.

```{r}
games_8 <- na.omit(games_7)

write.csv(games_8, "Microsimulation_games_2.csv", row.names = FALSE)
```

